<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Bar POS Simulator</title>
    <style>
        :root {
            --bg: #0b1220;
            --surface: #0f172a;
            --surface-2: #111827;
            --border: #374151;
            --text: #e5e7eb;
            --muted: #9ca3af;
            --accent: #8b5cf6;
            --accent-2: #6366f1;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, var(--bg) 0%, var(--surface-2) 100%);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: var(--surface-2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            color: var(--text);
            font-size: 28px;
            background: linear-gradient(135deg, var(--accent), #22d3ee);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .status-indicators {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--surface);
            border-radius: 8px;
        }

        .indicator-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #dc3545;
        }

        .indicator-dot.online {
            background: #28a745;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .catalog-section, .order-section {
            background: var(--surface);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .order-section {
            position: sticky;
            top: 20px;
            align-self: start;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }

        h2 {
            color: var(--text);
            font-size: 20px;
        }

        .catalog-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        .item-card {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, var(--surface-2) 0%, var(--surface) 100%);
        }

        .item-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .item-name {
            font-weight: 600;
            color: var(--text);
            font-size: 16px;
        }

        .item-category {
            font-size: 12px;
            color: #cbd5e1;
            background: var(--border);
            padding: 2px 8px;
            border-radius: 999px;
        }

        .item-price {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .price-range {
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 10px;
        }

        .item-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .price-input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--border);
            background: var(--surface-2);
            color: var(--text);
            border-radius: 8px;
            font-size: 14px;
        }

        .btn {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(0,0,0,0.10));
            color: var(--text);
            box-shadow: 0 1px 0 rgba(255,255,255,0.06) inset, 0 1px 2px rgba(0,0,0,0.2);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform .15s ease, box-shadow .15s ease, background-color .2s ease;
        }

        .btn:hover { transform: translateY(-1px); box-shadow: 0 6px 14px rgba(0,0,0,0.25); }
        .btn:active { transform: translateY(0); box-shadow: 0 2px 6px rgba(0,0,0,0.25); }
        .btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-2), var(--accent));
            border-color: transparent;
            color: #fff;
        }

        .btn-primary:hover {
            filter: brightness(1.05);
        }

        .btn-success {
            background: linear-gradient(135deg, #16a34a, var(--success));
            border-color: transparent;
            color: #fff;
        }

        .btn-success:hover {
            filter: brightness(1.05);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
            border-color: transparent;
            color: #111827;
        }

        .btn-warning:hover {
            filter: brightness(1.05);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, var(--danger));
            border-color: transparent;
            color: #fff;
        }

        .quantity-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }

        .quantity {
            padding: 6px 12px;
            background: var(--surface-2);
            color: var(--text);
            border-radius: 8px;
            min-width: 40px;
            text-align: center;
        }

        .order-items {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid var(--border);
        }

        .order-totals {
            border-top: 2px solid var(--border);
            padding-top: 10px;
        }

        .total-line {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }

        .total-line.grand-total {
            font-weight: bold;
            font-size: 18px;
            color: var(--accent);
        }

        .actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .actions .btn {
            flex: 1;
        }

        .event-log {
            margin-top: 20px;
            background: var(--surface);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .log-entries {
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            background: var(--surface-2);
            color: var(--text);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .log-entry {
            margin: 2px 0;
            padding: 4px 6px;
            border-left: 3px solid var(--border);
        }

        .log-entry.order { color: var(--success); border-left-color: var(--success); }
        .log-entry.price { color: var(--accent); border-left-color: var(--accent); }
        .log-entry.menu { color: var(--warning); border-left-color: var(--warning); }

        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: var(--surface-2); }
        ::-webkit-scrollbar-thumb { background: #1f2937; border-radius: 6px; border: 2px solid var(--surface-2); }
        ::-webkit-scrollbar-thumb:hover { background: #374151; }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üç∫ Market Bar POS Simulator</h1>
            <div class="status-indicators">
                <div class="indicator">
                    <span class="indicator-dot" id="wsStatus"></span>
                    <span id="wsStatusText">Offline</span>
                </div>
                <div class="indicator">
                    <span>Menu v<span id="menuVersion">1</span></span>
                </div>
            </div>
        </header>

        <div class="main-content">
            <div class="catalog-section">
                <div class="section-header">
                    <h2>üìã Catalog</h2>
                    <button class="btn btn-warning" onclick="simulateRandomOrders()">
                        üé≤ Simulate 10 Random Orders
                    </button>
                </div>
                <div class="catalog-grid" id="catalogGrid">
                    <!-- Items will be populated here -->
                </div>
            </div>

            <div class="order-section">
                <div class="section-header">
                    <h2>üõí Current Order</h2>
                </div>
                <div class="order-items" id="orderItems">
                    <p style="color: #999; text-align: center;">No items in order</p>
                </div>
                <div class="order-totals">
                    <div class="total-line">
                        <span>Subtotal:</span>
                        <span id="subtotal">$0.00</span>
                    </div>
                    <div class="total-line">
                        <span>Tax:</span>
                        <span id="tax">$0.00</span>
                    </div>
                    <div class="total-line grand-total">
                        <span>Total:</span>
                        <span id="total">$0.00</span>
                    </div>
                </div>
                <div class="actions">
                    <button class="btn btn-success" onclick="ringOrder()">üí≥ Ring Order</button>
                    <button class="btn btn-danger" onclick="clearOrder()">üóëÔ∏è Clear</button>
                </div>
            </div>
        </div>

        <div class="event-log">
            <div class="section-header">
                <h2>üìä Live Events</h2>
                <button class="btn btn-primary" onclick="clearLog()">Clear Log</button>
            </div>
            <div class="log-entries" id="logEntries">
                <div class="log-entry">Waiting for events...</div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        const WS_URL = `${window.location.protocol === 'https:' ? 'wss' : 'ws'}://${window.location.host}/ws`;
        let ws = null;
        let catalog = [];
        let currentOrder = {};
        let menuVersion = 1;

        // Initialize
        async function init() {
            await loadCatalog();
            connectWebSocket();
        }

        // Load catalog
        async function loadCatalog() {
            try {
                const response = await fetch(`${API_URL}/catalog/items`);
                const data = await response.json();
                catalog = data.items;
                menuVersion = data.menuVersion;
                document.getElementById('menuVersion').textContent = menuVersion;
                renderCatalog();
            } catch (error) {
                console.error('Failed to load catalog:', error);
            }
        }

        // Render catalog
        function renderCatalog() {
            const grid = document.getElementById('catalogGrid');
            grid.innerHTML = catalog.map(item => `
                <div class="item-card">
                    <div class="item-header">
                        <div>
                            <div class="item-name">${item.name}</div>
                        </div>
                        <div class="item-category">${item.category}</div>
                    </div>
                    <div class="item-price">$${item.price.toFixed(2)}</div>
                    <div class="price-range">
                        Range: $${item.minPrice} - $${item.maxPrice}
                    </div>
                    <div class="item-controls">
                        <input type="number" 
                               class="price-input" 
                               id="price-${item.id}" 
                               value="${item.price}" 
                               min="${item.minPrice}" 
                               max="${item.maxPrice}" 
                               step="0.5">
                        <button class="btn btn-primary" onclick="updatePrice('${item.id}')">
                            Set Price
                        </button>
                    </div>
                    <div class="quantity-controls">
                        <button class="btn btn-primary" onclick="addToOrder('${item.id}', '${item.name}', ${item.price})">
                            ‚ûï Add to Order
                        </button>
                        <span class="quantity" id="qty-${item.id}">
                            ${currentOrder[item.id] ? currentOrder[item.id].quantity : 0}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        // Update price
        async function updatePrice(itemId) {
            const priceInput = document.getElementById(`price-${itemId}`);
            const newPrice = parseFloat(priceInput.value);

            try {
                const response = await fetch(`${API_URL}/pricing/${itemId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': 'pos-sim-dev-key'
                    },
                    body: JSON.stringify({
                        price: newPrice,
                        publish: true
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    alert(`Error: ${error.error}`);
                    return;
                }

                const data = await response.json();
                const item = catalog.find(i => i.id === itemId);
                if (item) {
                    item.price = newPrice;
                    renderCatalog();
                }
                
                addLog(`price`, `Price updated: ${item.name} ‚Üí $${newPrice}`);
            } catch (error) {
                console.error('Failed to update price:', error);
                alert('Failed to update price');
            }
        }

        // Add to order
        function addToOrder(itemId, name, price) {
            if (!currentOrder[itemId]) {
                currentOrder[itemId] = { name, price, quantity: 0 };
            }
            currentOrder[itemId].quantity++;
            updateOrderDisplay();
            document.getElementById(`qty-${itemId}`).textContent = currentOrder[itemId].quantity;
        }

        // Update order display
        function updateOrderDisplay() {
            const orderItems = document.getElementById('orderItems');
            const items = Object.entries(currentOrder).filter(([_, item]) => item.quantity > 0);
            
            if (items.length === 0) {
                orderItems.innerHTML = '<p style="color: #999; text-align: center;">No items in order</p>';
                document.getElementById('subtotal').textContent = '$0.00';
                document.getElementById('tax').textContent = '$0.00';
                document.getElementById('total').textContent = '$0.00';
                return;
            }

            let subtotal = 0;
            orderItems.innerHTML = items.map(([id, item]) => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;
                return `
                    <div class="order-item">
                        <span>${item.quantity}x ${item.name}</span>
                        <span>$${itemTotal.toFixed(2)}</span>
                    </div>
                `;
            }).join('');

            const tax = subtotal * 0.0825;
            const total = subtotal + tax;

            document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('tax').textContent = `$${tax.toFixed(2)}`;
            document.getElementById('total').textContent = `$${total.toFixed(2)}`;
        }

        // Ring order
        async function ringOrder() {
            const items = Object.entries(currentOrder)
                .filter(([_, item]) => item.quantity > 0)
                .map(([itemId, item]) => ({
                    itemId,
                    qty: item.quantity
                }));

            if (items.length === 0) {
                alert('Please add items to the order');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ items })
                });

                if (!response.ok) {
                    const error = await response.json();
                    alert(`Error: ${error.error}`);
                    return;
                }

                const order = await response.json();
                addLog('order', `Order created: #${order.id} - Total: $${order.total}`);
                clearOrder();
            } catch (error) {
                console.error('Failed to create order:', error);
                alert('Failed to create order');
            }
        }

        // Clear order
        function clearOrder() {
            currentOrder = {};
            updateOrderDisplay();
            catalog.forEach(item => {
                const qtyEl = document.getElementById(`qty-${item.id}`);
                if (qtyEl) qtyEl.textContent = '0';
            });
        }

        // Simulate random orders
        async function simulateRandomOrders() {
            const button = event.target;
            button.disabled = true;
            button.textContent = 'Simulating...';

            for (let i = 0; i < 10; i++) {
                const itemCount = Math.floor(Math.random() * 3) + 1;
                const items = [];
                
                for (let j = 0; j < itemCount; j++) {
                    const randomItem = catalog[Math.floor(Math.random() * catalog.length)];
                    const qty = Math.floor(Math.random() * 3) + 1;
                    items.push({ itemId: randomItem.id, qty });
                }

                try {
                    await fetch(`${API_URL}/orders`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ items })
                    });
                    await new Promise(resolve => setTimeout(resolve, 500));
                } catch (error) {
                    console.error('Failed to create order:', error);
                }
            }

            button.disabled = false;
            button.textContent = 'üé≤ Simulate 10 Random Orders';
        }

        // WebSocket connection
        function connectWebSocket() {
            ws = new WebSocket(WS_URL);

            ws.onopen = () => {
                document.getElementById('wsStatus').classList.add('online');
                document.getElementById('wsStatusText').textContent = 'Online';
                addLog('system', 'WebSocket connected');
            };

            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    handleWebSocketMessage(message);
                } catch (error) {
                    console.error('Failed to parse WebSocket message:', error);
                }
            };

            ws.onclose = () => {
                document.getElementById('wsStatus').classList.remove('online');
                document.getElementById('wsStatusText').textContent = 'Offline';
                addLog('system', 'WebSocket disconnected');
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        // Handle WebSocket messages
        function handleWebSocketMessage(message) {
            switch (message.event) {
                case 'order.created':
                    addLog('order', `Order created: #${message.data.id} - $${message.data.total}`);
                    break;
                case 'price.updated':
                    addLog('price', `Price updated: ${message.data.name} ‚Üí $${message.data.newPrice}`);
                    if (message.data.menuVersion) {
                        menuVersion = message.data.menuVersion;
                        document.getElementById('menuVersion').textContent = menuVersion;
                    }
                    loadCatalog();
                    break;
                case 'menu.published':
                    addLog('menu', `Menu published: v${message.data.menuVersion}`);
                    menuVersion = message.data.menuVersion;
                    document.getElementById('menuVersion').textContent = menuVersion;
                    break;
            }
        }

        // Add log entry
        function addLog(type, message) {
            const logEntries = document.getElementById('logEntries');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logEntries.appendChild(entry);
            logEntries.scrollTop = logEntries.scrollHeight;

            // Keep only last 100 entries
            while (logEntries.children.length > 100) {
                logEntries.removeChild(logEntries.firstChild);
            }
        }

        // Clear log
        function clearLog() {
            document.getElementById('logEntries').innerHTML = '<div class="log-entry">Log cleared</div>';
        }

        // Initialize on load
        window.addEventListener('load', init);
    </script>
</body>
</html>
